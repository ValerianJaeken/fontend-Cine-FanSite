History=function(){function a(){var a=document.createElement("IFRAME");a.id="historyIframe",a.style.display="none",document.body.appendChild(a),z=a.contentWindow,A=z.document,A.open(),A.close()}function b(){var a=f(this.document.location.hash);s!==a&&(s=a,window.parent.location.hash=s,m(s))}function c(a){r!==f(a.hash)&&(r=f(unescape(a.hash)),m(r))}function d(){r=t.hash,w?(a(),s=A.location.hash,setInterval(function(){b.call(z)},100)):"onhashchange"in window&&!x?window.onhashchange=function(){m(f(t.hash))}:setInterval(function(){c(t)},100)}function e(a){for(var b=0,c=0;c<a.length;c++)b+=a.charCodeAt(c);return b}function f(a){var b="",c=a.match(/(?:#|\?)?(.*)/);return c?c[1]:b}function g(a){this.document.open(),this.document.close(),this.document.location.hash=a}function h(a){var b=window.scrollY||document.documentElement.scrollTop;location.hash=a,window.scrollTo(0,b)}function i(a){if(w)g.call(z,a);else if(y&&B){var b=document.querySelector("link[type='image/x-icon']");if(null!==b){var c=document.head||document.getElementsByTagName("head")[0]||document.documentElement;c.appendChild(b)}B=!1,h(a)}else v?h(a):location.hash=a}function j(){return"undefined"!=typeof p[q]?JSON.parse(JSON.stringify(p[q])):null}function k(){return JSON.parse(JSON.stringify(p))}function l(a){q=e(a.hash),p[q]=a}function m(a){q=e(a);var b=p[q];!b||b.hash===u&&C||(document.title=b.title,o(),C=!1)}function n(a,b,c){C=!0,u=f(t.hash),a=JSON.parse(JSON.stringify(a));var d=f(decodeURIComponent(c)),e={data:a,url:c,hash:d,title:b};l(e),i(d)}var o=function(){},p={},q=0,r="",s="",t=window.location,u="",v=!!window.attachEvent,w=navigator.userAgent.indexOf("MSIE 6.0")>-1,x=7===document.documentMode,y="undefined"!=typeof window.mozInnerScreenX,z={},A={},B=!0,C=!1;if(navigator.userAgent.indexOf("MSIE 7.0")>-1){var D="";!function(){var a=document.title||"";document.onpropertychange=function(){var b=document.title||"";"title"===window.event.propertyName&&b!==a&&document.title.indexOf("#")!==-1?document.title=D:D=document.title}}()}return d(),{pushState:n,getState:j,getAllStates:k,getHashCode:e,bind:function(a){o=a}}}(),define("ytos.search",[],function(){return yTos.utils.namespace("yTos.models.Search"),yTos.models.Search=yTos.models.base.extend({initialize:function(a){var b=yTos.navigation.Controller;this.isSearchPage=("Search"===b||"SearchCube"===b)&&"Index"===yTos.navigation.Action,this.isEmptySearchResult=$Y.queryString("emptySearchResult");var c=$Y.utils.queryString("textsearch")||$Y.utils.queryString("textSearch");this.isSearchPage&&(yTos.storage.set("yTos.navigation.LatestSearchInfos",{filtersChanged:!1}),"string"==typeof c?yTos.storage.set("yTos.navigation.LatestSearchHasTextSearch",!0):yTos.storage.set("yTos.navigation.LatestSearchHasTextSearch",!1)),yTos.search&&yTos.search.gender&&yTos.search.gender.length>1&&!c&&(yTos.search.gender=[]),this.set({landingFilters:yTos.search}),this.set({filters:yTos.search}),this.set({firstPushState:!1});var d={totalItems:parseInt($Y.safeGet(yTos,"search.totalItems")||0,10),partialLoadedItems:parseInt($Y.safeGet(yTos,"search.partialLoadedItems")||0,10),itemsToLoadOnNextPage:parseInt($Y.safeGet(yTos,"search.itemsToLoadOnNextPage")||0,10)};this.set({loadedItemsInformation:d}),this.watch("change:filters",function(){yTos.storage.set("yTos.navigation.LatestSearchInfos",{filtersChanged:!0}),this.updateLoadedItemsInfo(),this.pushState(),this.saveLatest()},this),History.bind(this.onStateChange.bind(this)),this.isSearchPage&&(this.saveSiteCode(),this.saveLatest()),this.updateAttributesFromLocalStorage();var e=window.location.hash.substr(1);if(e=decodeURIComponent(e),$Y.utils.isJson(e)){var f=JSON.parse(e),g=this.compareObjs(f,yTos.search);g&&"page"!==g&&this.set("mustResetProducts",!0),f&&f.facetsvalue&&(f.facetsvalue=f.facetsvalue.map(function(a){return encodeURIComponent(a)})),this.set("filters",f),this.set("mustUpdate",!0)}this.set("autoSwitchMacroMicro",$Y.safeGet(yTos.configuration,"search.autoSwitchMacroMicro")),this.get("autoSwitchMacroMicro")&&this._getRefinements()},_getRefinements:function(){var a=this.getFilters(),b=$Y.jsonToQueryString(a).replace(/\w+=&/gi,"");yTos.ajax("/yTos/api/Plugins/SearchPluginApi/GetRefinementsAsync/",{data:{siteCode:$Y.siteCode(),queryString:b},success:function(b){this._setMacroMicroDictionary(b.Filters),this._verifySwitchMacroMicro(a)}.bind(this)})},_setMacroMicroDictionary:function(a){if(a){var b={},c={},d=a.Categories||[];d.forEach(function(a,d){var e=a.Children;b[a.Id]=e.map(function(a,b){return a.Id}),e.forEach(function(b,d){c[b.Id]=a.Id})}),this.set("macrosDictionary",b),this.set("microsDictionary",c)}},updateLoadedItemsInfo:function(){var a=parseInt(this.attributes.loadedItemsInformation.totalItems,10),b=parseInt(this.attributes.filters.productsPerPage,10),c=b*parseInt(this.attributes.filters.page,10),d=c<a?c:a,e=a-d,f={totalItems:a,partialLoadedItems:d,itemsToLoadOnNextPage:e>=b?b:e};this.set({loadedItemsInformation:f})},compareObjs:function(a,b){var c=!1;for(var d in a)if(a[d]!==b[d]){if("page"!==d)return d;c=d}return c},defaults:{filtersChanged:!1,filters:{},refinements:{},macrosDictionary:{},microsDictionary:{}},trackingHandlers:{"yTos::Search::filterAdded":function(a){if("page"!==a.key){var b="Filter",c="_ON",d=a.key.charAt(0).toUpperCase()+a.key.slice(1);yTos.tracking.trackEvent({event:d,label:a.value,prefix:b,suffix:c})}},"yTos::Search::filterRemoved":function(a){var b="",c="_OFF",d=a.key.charAt(0).toUpperCase()+a.key.slice(1);yTos.tracking.trackEvent({event:d,label:a.value,prefix:b,suffix:c})},"yTos::Search::filterReset":function(){yTos.tracking.trackEvent({event:"Reset",prefix:"Filter"})},"yTos::Search::filtersFullReset":function(){yTos.tracking.trackEvent({event:"Reset",prefix:"Filter"})},"yTos::Search::GoToNextItemClicked":function(a){yTos.tracking.trackEvent({event:"Same Micro",label:a.label,driver:"TC"}),yTos.tracking.trackEvent({event:"GoTo",label:a.label,driver:"GA"})},"yTos::Search::GoToPreviousItemClicked":function(a){yTos.tracking.trackEvent({event:"Same Micro",label:a.label,driver:"TC"}),yTos.tracking.trackEvent({event:"GoTo",label:a.label,driver:"GA"})}},getFilterData:function(a){var b=$(a.currentTarget).data(),c={};return c[this.options.dimension]=b.ytosMdl,c},getFilters:function(){return $Y.mixin({},this.get("filters"),!0)},toggleFilters:function(a,b,c){for(var d,e=Object.keys(a),f="",g=0;d=e[g];g++)f=a[d].toString(),"undefined"==typeof this.attributes.filters[d]&&(this.attributes.filters[d]=[]),$Y.isIn(f,this.attributes.filters[d])?this.removeFilter({key:d,value:f},b,c):this.setFilter({key:d,value:f},b,c)},setFilter:function(a,b,c){var d=this.getFilters();a.value=a.value.toString(),b?(Array.isArray(d[a.key])||(d[a.key]=[]),d[a.key].push(a.value)):d[a.key]=a.value,"page"!==a.key?(d.page=1,this.set("isFiltering",!0)):this.set("isFiltering",!1);var e=!1,f=!1,g=d.gender;Array.isArray(g)&&(e=g.indexOf("D")>-1,f=g.indexOf("U")>-1,e&&f&&(d.gender=[])),this.set("filters",d),this.set("lastFilterClicked",a),this.notify("yTos::Search::filterAdded",{key:c?c:a.key,value:a.value})},removeFilter:function(a,b,c){var d,e=this.getFilters(),f=$Y.mixin({},e,!0),g="",h=f[a.key];if(b){h=Array.isArray(h)?h:[h];var i=h.indexOf(a.value);h.splice(i,1),d=h}else d="";"page"!==a.key?(f.page=1,this.set("isFiltering",!0)):this.set("isFiltering",!1),g=d.toString(),f[a.key]=d,this.set("filters",f),this.set("lastFilterClicked",a),this.notify("yTos::Search::filterRemoved",{key:c?c:a.key,value:a.value})},emptyFilters:function(a,b){var c=this.getFilters();"undefined"==typeof a?(Array.isArray(c.gender)&&(this.attributes.filters.gender=[]),this.set("mustResetProducts",!0),this.set({filters:yTos.search}),this.notify("yTos::Search::filtersFullReset")):(a=a.toLowerCase(),Array.isArray(c[a])?c[a]=yTos.search[a]||[]:c[a]=yTos.search[a]||"",this.set("filters",c),this.notify("yTos::Search::filterReset",{key:b?b:a,value:c[a]})),this.set("lastFilterClicked",null)},emptyFilterByValues:function(a,b,c){var d=this.getFilters();a=a.toLowerCase(),d[a]=Array.isArray(d[a])?d[a]:[];var e=!1;b.forEach(function(b){var c=d[a].map(function(a){return decodeURIComponent(a.toUpperCase())}).indexOf(decodeURIComponent(b.toUpperCase()));c!==-1&&(d[a].splice(c,1),e=!0)}),e&&(this.set("filters",d),this.notify("yTos::Search::filterReset",{key:c?c:a,value:d[a]}),this.set("lastFilterClicked",null))},getEscapedFilters:function(){return encodeURIComponent(yTos.utils.jsonToQueryString(this.attributes.filters))},getEscapedFiltersForProducts:function(a){var b=$.extend(!0,{},this.attributes.filters,a);return this.get("autoSwitchMacroMicro")&&this._verifySwitchMacroMicro(b),yTos.utils.jsonToQueryString(b)},_autoSwitchMacroMicro:function(a,b,c){if("macro"===a||"micro"===a){var d="micro"===a?"macro":"micro",e=a+"sDictionary";if(!$.isArray(c[d]))return void(c[d]="");var f=this.get(e),g=f[b];if($.isArray(g))return void this._removeRelatedCombination(d,g,c);var h=c[d].indexOf(g);h<0||c[d].splice(h,1)}},_removeRelatedCombination:function(a,b,c){b.forEach(function(b){var d=c[a].indexOf(b);d<0||c[a].splice(d,1)})},_verifySwitchMacroMicro:function(a){var b=this.get("lastFilterClicked");if(b&&"macro"===b.key&&this._autoSwitchMacroMicro("macro",b.value,a),a.micro)return Array.isArray(a.micro)?void a.micro.forEach(function(b){this._autoSwitchMacroMicro("micro",b,a)}.bind(this)):void this._autoSwitchMacroMicro("micro",a.micro,a)},getUrl:function(){var a=this.attributes.filters;for(var b in a)null!==a[b]&&void 0!==a[b]&&""!==a[b]||delete a[b];return"?"+JSON.stringify(a)},pushState:function(){History.pushState(this.attributes.filters,document.title,this.getUrl())},saveLatest:function(){yTos.storage.set("yTos.navigation.LatestSearchFilters",this.attributes.filters)},updateAttributesFromLocalStorage:function(){this.set({latestSearchFilters:yTos.storage.get("yTos.navigation.LatestSearchFilters"),latestSearchSiteCode:yTos.storage.get("yTos.navigation.LatestSearchSiteCode")})},onStateChange:function(){var a=History.getState();a.url!==this.getUrl()&&this.set({filters:a.data})},saveSiteCode:function(){yTos.storage.set("yTos.navigation.LatestSearchSiteCode",yTos.navigation.SiteCode)}}),yTos.models.Searches=yTos.helpers.createCollection(yTos.models.Search,"search"),yTos.models.Search});