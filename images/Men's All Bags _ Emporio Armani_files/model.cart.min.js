define("ytos.cart",[],function(){return yTos.utils.namespace("yTos.models.Cart"),yTos.models.Cart=function(){var a=yTos.models.base.extend({_nextStepRequest:!1,_expectedSubmits:{},initialize:function(a){this.attributes=$.extend(this.defaults,a),this.watch("change:siteCode",function(){this.notify("yTos::CountryChanged",{siteCode:this.get("siteCode")})},this),"delivery"!==this.get("currentStep")&&"confirmation"!==this.get("currentStep")||this.set({handleCartWarnings:!0})},defaults:{paymentType:"1",payWithNewCreditCard:!1,isLanding:!0,checkoutType:$Y.safeGet(yTos,"navigation.Area"),currentStep:"undefined"!=typeof yTos.navigation&&"string"==typeof yTos.navigation.Controller?yTos.navigation.Controller.toLowerCase():"",siteCode:"undefined"!=typeof yTos.navigation?yTos.navigation.SiteCode:"",handleCartWarnings:!1,formsToCheck:{Gift:!1,Billing:!1,BillingAddressId:!1,Shipping:!1,ShippingAddressId:!1,CreditCard:!1,CreditCardLight:!1,Cvv:!1,Guid:!1,ExpirationDate:!1,PickupInStore:!1,CvvAndExpirationDate:!1},payPalExpress:{Token:"",PayerId:""},ShippingFormBeforePickupInStore:""},globalMessages:{"yTos::AjaxForm::FormValidated":"onFormValidated","yTos::PickUpInStore::InvalidCitySelected":"onInvalidCitySelected","yTos::Cart::CheckCartWarningsDone":"goToNextPage","yTos::Cart::GoToNextStepReady":"checkCartWarnings","yTos::Cart::GuestEmailSet":"goToNextPage","yTos::Cart::UserLoggedIn":"goToNextPage","yTos::Cart::CheckNextStepReady":"checkNextStepReady","yTos::Cart::GoToNextStepRequest":"checkNextStepReady","yTos::Cart::NextPageButtonClicked":"onNextPageButtonClicked","yTos::Paypalexpress::NextPageButtonClicked":"onNextPageButtonClicked","yTos::Cart::ShippingAddressFormSuccess":"shippingAddressSaveSuccess","yTos::Cart::ShippingAddressFormError":"shippingAddressSaveError","yTos::Cart::BillingAddressFormSuccess":"billingAddressSaveSuccess","yTos::Cart::BillingAddressFormError":"billingAddressSaveError","yTos::Cart::ShippingFormSuccess":"shippingAddressSaveSuccess","yTos::Cart::ShippingFormError":"shippingAddressSaveError","yTos::Cart::BillingFormSuccess":"billingAddressSaveSuccess","yTos::Cart::BillingFormError":"billingAddressSaveError","yTos::Cart::SetShippingAddressByAddressIdSuccess":"shippingAddressByAddressIdSaveSuccess","yTos::Cart::SetShippingAddressByAddressIdError":"shippingAddressByAddressIdSaveError","yTos::Cart::SetBillingAddressByAddressIdSuccess":"billingAddressByAddressIdSaveSuccess","yTos::Cart::SetBillingAddressByAddressIdError":"billingAddressByAddressIdSaveError","yTos::Cart::CreditCardFormSuccess":"creditCardSaveSuccess","yTos::Cart::CreditCardFormError":"creditCardSaveError","yTos::Cart::CreditCardFormLightSuccess":"creditCardLightSaveSuccess","yTos::Cart::CreditCardFormLightError":"creditCardLightSaveError","yTos::Cart::GuidSaveSuccess":"guidSaveSuccess","yTos::Cart::GuidSaveError":"guidSaveError","yTos::Cart::GiftFormSuccess":"giftSaveSuccess","yTos::Cart::GiftFormError":"giftSaveError","yTos::Cart::ConfirmationCvvSubmitSuccess":"confirmationCvvSubmitSuccess","yTos::Cart::ConfirmationCvvSubmitError":"confirmationCvvSubmitError","yTos::Cart::CvvAndExpirationFormSubmitSuccess":"cvvAndExpirationSaveSuccess","yTos::Cart::CvvAndExpirationFormSubmitError":"cvvAndExpirationSaveError","yTos::Cart::ExpirationFormSubmitSuccess":"ExpirationSaveSuccess","yTos::Cart::ExpirationFormSubmitError":"ExpirationSaveError","yTos::PickUpInStore::SetStoreIdSuccess":"storeIdSaveSuccess","yTos::PickUpInStore::SetStoreIdError":"storeIdSaveError","yTos::HelperDestroyed::cart.shippingForm":"shippingFormHelperDestroyed","yTos::InvalidUserSession":"_manageInvalidSession"},getPaymentMethodId:function(a){switch(a=a.toLowerCase()){case"creditcard":return"1";case"creditcardglobalcollect":return"201";case"cashondelivery":return"2";case"cashondeliveryglobalcollect":return"202";case"paypal":return"300";case"paypalexpress":return"330";case"alipay":return"500";case"payeasy":return"601";case"payeasyinternational":return"602";case"wiretransfer":return"850";case"sofort":return"750";default:return"1"}},switchFromShippingAddressToPickupInStore:function(){var a=this.get("formsToCheck");a.Shipping?this.set({ShippingFormBeforePickupInStore:"Shipping"}):a.ShippingAddressId&&this.set({ShippingFormBeforePickupInStore:"ShippingAddressId"}),this.set({formsToCheck:{Shipping:!1,ShippingAddressId:!1,PickupInStore:!0}})},switchFromPickupInStoreToShippingAddress:function(){var a=this.get("ShippingFormBeforePickupInStore");switch(a){case"Shipping":this.set({formsToCheck:{Shipping:!0,PickupInStore:!1}});break;case"ShippingAddressId":this.set({formsToCheck:{ShippingAddressId:!0,PickupInStore:!1}});break;default:this.set({formsToCheck:{PickupInStore:!1}})}},shippingFormHelperDestroyed:function(a){this._manageFormSuccess("Shipping")},shippingAddressSaveSuccess:function(){this._manageFormSuccess("Shipping")},shippingAddressSaveError:function(){this._manageFormError("Shipping")},billingAddressSaveSuccess:function(){this._manageFormSuccess("Billing")},billingAddressSaveError:function(){this._manageFormError("Billing")},billingAddressByAddressIdSaveSuccess:function(){this._manageFormSuccess("BillingAddressId")},billingAddressByAddressIdSaveError:function(){this._manageFormError("BillingAddressId")},shippingAddressByAddressIdSaveSuccess:function(){this._manageFormSuccess("ShippingAddressId")},shippingAddressByAddressIdSaveError:function(){this._manageFormError("ShippingAddressId")},giftSaveSuccess:function(){this._manageFormSuccess("Gift")},giftSaveError:function(){this._manageFormError("Gift")},creditCardSaveSuccess:function(){this._manageFormSuccess("CreditCard")},creditCardSaveError:function(){this._manageFormError("CreditCard")},creditCardLightSaveSuccess:function(){this._manageFormSuccess("CreditCardLight")},creditCardLightSaveError:function(){this._manageFormError("CreditCardLight")},cvvAndExpirationSaveSuccess:function(){this._manageFormSuccess("CvvAndExpirationDate")},cvvAndExpirationSaveError:function(){this._manageFormError("CvvAndExpirationDate")},ExpirationSaveSuccess:function(){this._manageFormSuccess("ExpirationDate")},ExpirationSaveError:function(){this._manageFormError("ExpirationDate")},confirmationCvvSubmitSuccess:function(){this._manageFormSuccess("Cvv")},confirmationCvvSubmitError:function(){this._manageFormError("Cvv")},guidSaveSuccess:function(){this._manageFormSuccess("Guid")},guidSaveError:function(){this._manageFormError("Guid")},storeIdSaveSuccess:function(){this._manageFormSuccess("PickupInStore")},storeIdSaveError:function(){this._manageFormError("PickupInStore")},_manageFormSuccess:function(a){this._expectedSubmits[a]=!0;var b={};b[a]=!1,this.set({formsToCheck:b}),this.checkNextStepReady()},_manageFormError:function(a){this._expectedSubmits[a]=!0,this._nextStepRequest&&(this._nextStepRequest=!1,this.notify("yTos::Cart::GoToNextStepNotReady"))},_manageInvalidSession:function(){this._nextStepRequest=!1},onNextPageButtonClicked:function(){if(this._nextStepRequest)return void this.notify("yTos::Cart::AlreadyRequestingNextPageAlert");var a=this.get("currentStep");this._nextStepRequest=!0,"cart"===a&&this.notify("yTos::Cart::CheckoutStarted"),this._expectedSubmits={},$.each(this.get("formsToCheck"),function(a,b){b&&(this._expectedSubmits[a]=!1)}.bind(this)),this.notify("yTos::Cart::GoToNextStepRequest",{currentStep:a})},checkNextStepReady:function(){if(this._nextStepRequest){var a=!0;$.each(this._expectedSubmits,function(b,c){a=a&&c}),a&&(this.checkFormsToSubmit()?this.notify("yTos::Cart::GoToNextStepReady"):(this._nextStepRequest=!1,this.notify("yTos::Cart::GoToNextStepNotReady")))}},onFormValidated:function(a){this._nextStepRequest&&!a.isFormValid&&(this._nextStepRequest=!1,this.notify("yTos::Cart::GoToNextStepNotReady"))},onInvalidCitySelected:function(){this._nextStepRequest&&(this._nextStepRequest=!1,this.notify("yTos::Cart::GoToNextStepNotReady"))},checkFormsToSubmit:function(){var a=this.get("formsToCheck"),b=!0;for(var c in a)a.hasOwnProperty(c)&&a[c]!==!1&&(b=!1);return b},trackingHandlers:{"yTos::Cart::PaymentMethodClicked":function(a){var b=a.paymentType;yTos.tracking.trackEvent({event:"Payment_Type_Changed",label:b})},"yTos::Cart::GiftWrappingSet":function(){yTos.tracking.trackEvent({event:"Gift_selected"})},"yTos::Cart::GiftWrappingUnset":function(){yTos.tracking.trackEvent({event:"Gift_removed"})},"yTos::Cart::ItemsAdded":function(a){var b=a.itemData,c=a.model;yTos.tracking.trackEvent({event:"AddToCart",label:b.code10,value:b.size,driver:"GA"}),yTos.tracking.trackAddItem({product_cod10:b.code10,product_title:(c.productTitle||"").toUpperCase(),product_category:c.productCategoryId+"/"+c.productMicroId,product_brand:(c.productBrand||"").toUpperCase(),product_color:b.colorData&&b.colorData[0]?b.colorData[0].ColorId:b.code10,product_price:c.productUnitpriceTf,product_discount_price:c.productDiscountTf,product_price_ati:c.productUnitpriceAti,product_discount_price_ati:c.productDiscountAti,product_quantity:1})},"yTos::Cart::ErrorAddingItems":function(){yTos.tracking.trackEvent({event:"AddToCart",label:"Error"})},"yTos::Cart::ItemRemoved":function(a){$Y.models.Cart._removeItemTrackingEvent(a)},"yTos::Cart::ItemsDeleted":function(a){$Y.models.Cart._removeItemTrackingEvent(a)},"yTos::Tracking::ItemQuantityIncreased":function(a){var b=a.itemData,c=a.model;yTos.tracking.trackAddItem({product_cod10:b.code10,product_title:(c.productTitle||"").toUpperCase(),product_category:c.productCategoryId+"/"+c.productMicroId,product_brand:(c.productBrand||"").toUpperCase(),product_color:b.colorData&&b.colorData[0]?b.colorData[0].ColorId:b.code10,product_price:c.productUnitpriceTf,product_discount_price:c.productDiscountTf,product_price_ati:c.productUnitpriceAti,product_discount_price_ati:c.productDiscountAti,product_quantity:1})},"yTos::Tracking::ItemQuantityDecreased":function(a){var b=a.itemData,c=a.model;yTos.tracking.trackRemoveItem({product_cod10:b.code10,product_title:(c.productTitle||"").toUpperCase(),product_category:c.productCategoryId+"/"+c.productMicroId,product_brand:(c.productBrand||"").toUpperCase(),product_color:b.colorData&&b.colorData[0]?b.colorData[0].ColorId:b.code10,product_price:c.productUnitpriceTf,product_discount_price:c.productDiscountTf,product_price_ati:c.productUnitpriceAti,product_discount_price_ati:c.productDiscountAti,product_quantity:1})},"yTos::Cart::CartLinkClicked":function(a){a.isDefaultBehaviourDisabled||yTos.tracking.trackEvent({event:"GoToCart"})},"yTos::MiniCart::GoToCartClicked":function(a){a.isDefaultBehaviourDisabled||yTos.tracking.trackEvent({event:"GoToCart"})},"yTos::Cart::CheckoutStarted":function(a){yTos.tracking.trackEvent({event:"ProceedToCheckout"})},"yTos::Cart::UserLoginError":function(){yTos.tracking.trackEvent({event:"Login",label:"Error",value:"Checkmail"})},"yTos::Cart::EditButtonClicked":function(a){yTos.tracking.trackEvent(a)}},checkCartWarnings:function(){var a=this.get("currentStep");this.get("handleCartWarnings")?yTos.ajax("/yTos/Plugins/CartPlugin/TryRenderCartWarning",{success:function(b){this.set({handleCartWarnings:!1}),this.notify("yTos::Cart::CheckCartWarningsDone",{currentStep:a})}.bind(this),error:function(a){var b=$($.trim(a.responseText));this.notify("yTos::OpenLayer",{content:b}),this.notify("yTos::Cart::ShowCartWarning"),this._nextStepRequest=!1,yTos.helpers.initializeHelpers(b)}.bind(this)}):this.notify("yTos::Cart::CheckCartWarningsDone",{currentStep:a})},goToNextPage:function(){var a,b,c=this.get("currentStep");"checkoutpaypalexpress"===c?(b=this.get("payPalExpress"),a="/yTos/api/Plugins/PayPalExpressPluginApi/FinalizePayPalExpressCheckout"):(a="/yTos/api/Plugins/CartPluginApi/GetNextStep",b={currentStep:c}),yTos.ajax(a,{data:$Y.prepareData(b),success:function(a){if("undefined"!=typeof a.PaymentType&&"0"!==a.PaymentType.toString()&&"300"===a.PaymentType.toString()&&a.WaitframeLabel){var b="<div class='waitframeLabelMessage'>"+a.WaitframeLabel+"</div>";this.notify("yTos::OpenLayer",{html:b})}a.CheckoutStepUri&&""!==a.CheckoutStepUri&&(this.notify("yTos::Cart::RedirectingToNextStep",{currentStep:c}),"confirmation"===c&&yTos.cookie.del("SalesTaxesAlreadyCalculated"),$Y.redirect(a.CheckoutStepUri))}.bind(this),error:function(a){var b=jQuery.parseJSON(a.responseText),d="<div class='finalizationWarningMessage'>"+b.Message+"</div>";this.notify("yTos::OpenLayer",{html:d}),this.notify("yTos::Cart::GetNextStepError",{currentStep:c}),this.submitFormsOnFinalizationError(),this._nextStepRequest=!1,"PayPalExpress"===this.get("checkoutType")&&""!==b.LandingUrl&&$Y.redirect(b.LandingUrl)}.bind(this)})},submitFormsOnFinalizationError:function(){"confirmation"===this.get("currentStep")&&(this.get("payWithNewCreditCard")&&($("[data-ytos-ctrl='cart.creditCardLightForm']").length?this.set({formsToCheck:{CreditCardLight:!0}}):$("[data-ytos-ctrl='cart.creditCardForm']").length&&this.set({formsToCheck:{CreditCard:!0}})),$("[data-ytos-ctrl='cart.cvvAndExpirationForm']").length&&this.set({formsToCheck:{CvvAndExpirationDate:!0}}),$("[data-ytos-ctrl='cart.confirmationCvv']").length&&this.set({formsToCheck:{Cvv:!0}}))},_removeItemTrackingEvent:function(a){var b=a.itemData,c=a.model;yTos.tracking.trackRemoveItem({product_cod10:b.code10,product_title:(c.productTitle||"").toUpperCase(),product_category:c.productCategoryId+"/"+c.productMicroId,product_brand:(c.productBrand||"").toUpperCase(),product_color:c.productColorId,product_price:c.productUnitpriceTf,product_discount_price:c.productDiscountTf,product_price_ati:c.productUnitpriceAti,product_discount_price_ati:c.productDiscountAti,product_quantity:1})}});return new a}(),yTos.models.Cart});