define(["ytos.item","ui.picturePolyfill"],function(a,b){return yTos.utils.namespace("yTos.helpers.Item.MainImage"),yTos.helpers.Item.MainImage=yTos.helpers.base.extend({initialize:function(){var a=this.options.siteCode,b=this.options.code10;this.model=yTos.models.ItemsCollection({scope:this.options.code10},{code10:b,siteCode:a,disableGetCombination:!0}),this.imageSettings=$.extend(!0,{},this.options.imageOptions),this.imageSettings.Code10=this.model.get("selectedColor")||b,this.$mainGraphic=this.$el.find("img"),b&&b.toLowerCase()!==this.imageSettings.Code10.toLowerCase()&&(this.$el.find("img").hide(),this.changeMainImageColor(this.imageSettings.Code10),this.$el.find("img").show()),"undefined"==typeof this.model.get("selectedMainImageShot")&&(this.model.set("selectedMainImageShot",this.imageSettings.ImageShot),this.model.set("selectedMainImageSize",this.imageSettings.ImageSize)),this.model.watch("change:selectedColor",this.changeMainImageColor,this),this.model.watch("change:selectedMainImageShot",this.changeMainImageShot,this)},events:{"img click":"graphicClicked"},graphicClicked:function(a){this.notify("yTos::Item::MainImageClicked",this.imageSettings,{scope:this.scope})},changeMainImageColor:function(a){a&&(this.imageSettings.Code10=a),$Y.updateGraphic(this.$mainGraphic,this.imageSettings),this.notify("yTos::Item::MainImageColorUpdated",{el:this.el,data:this.imageSettings,code10:a}),this.notify("yTos::Ui:PicturePolyfill::PictureUpdated",{$el:this.$mainGraphic}),this.checkMainImageSrc()},changeMainImageShot:function(a){this.imageSettings.ImageShot=a,this.imageSettings.ImageFormat=this.imageSettings.ImageSize+"_"+a,this.imageSettings.Srcset&&this.imageSettings.Srcset.forEach(function(b,c){b.Shot=a,b.Format=b.Size+"_"+a}),$Y.updateGraphic(this.$mainGraphic,this.imageSettings),this.notify("yTos::Item::MainImageFormatUpdated",{el:this.el,data:this.imageSettings}),this.notify("yTos::Ui:PicturePolyfill::PictureUpdated",{$el:this.$mainGraphic}),this.checkMainImageSrc()},checkMainImageSrc:function(){var a=0,b=setInterval(function(){if(a++,a>5)return clearInterval(b);var c=this.$mainGraphic.prop("currentSrc")||this.$mainGraphic.prop("src");if(c){clearInterval(b);var d=document.createElement("img");d.onload=function(a){a.currentTarget.width<=1&&this.notify("yTos::Item::ErrorLoadingMainImage",{src:c,code10:this.model.get("selectedColor"),shot:this.model.get("selectedMainImageShot")},{scope:this.scope})}.bind(this),d.onerror=this.notify.bind(this,"yTos::Item::ErrorLoadingMainImage",{src:c,code10:this.model.get("selectedColor"),shot:this.model.get("selectedMainImageShot")},{scope:this.scope}),d.src=c}}.bind(this),200)}}),yTos.helpers.Item.MainImage});