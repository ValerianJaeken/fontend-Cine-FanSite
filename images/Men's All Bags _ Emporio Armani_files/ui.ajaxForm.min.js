define(["ui.scrollToError"],function(a){return yTos.utils.namespace("yTos.helpers.UI.AjaxForm"),yTos.helpers.UI.AjaxForm=function(){var a=yTos.helpers.base.extend({name:"ui.ajaxForm",initialize:function(){},validationTemplate:'<div data-ytos-validation-msg="" class="field-validation-error"></div>',events:{"^ document form[data-ytos-ajax] submit":"submitTroughAjax","^ document form[data-ytos-ajax] input[data-val] blur":"validateOnBlur","^ document form[data-ytos-ajax] textarea[data-val] blur":"validateOnBlur","^ document form[data-ytos-ajax] select[data-val] blur":"validateOnBlur","^ document form[data-ytos-ajax] [data-ytos-password-strength-validation] keyup":"passwordStrength","^ document form[data-ytos-ajax] textarea[data-ytos-char-count] keyup":"charCount"},globalMessages:{"yTos::AjaxForm::FormValidated":"onFormValidated"},onFormValidated:function(a){a.isFormValid||$Y.notify("yTos::AjaxForm::ScrollToErrorReady",$(a.form))},validationRules:[{name:"valRequired",validator:function(a,b){var c=a.val()||"";return""!==c.toString()||b.valRequiredCondition&&0===a.closest("form").find(b.valRequiredCondition).length?"":a.data("valRequired")}},{name:"valEqualto",validator:function(a,b,c){var d=a.closest("form"),e=b.valEqualtoOther.replace("*.",c+"."),f='input[name="'+e+'"]',g=d.find(f);return"email"===a.attr("type")?a.val().toLowerCase()===g.val().toLowerCase()?"":a.data("valEqualto"):a.val()===g.val()?"":a.data("valEqualto")}},{name:"valNotequalto",validator:function(a,b,c){var d=a.closest("form"),e=b.valNotequaltoOther.replace("*.",c+"."),f='input[name="'+e+'"]',g=d.find(f);return a.val()!==g.val()?"":a.data("valNotequalto")}},{name:"valLengthMax",validator:function(a,b){return a.val().length<=b.valLengthMax?"":a.data("valLength")}},{name:"valLengthMin",validator:function(a,b){return a.val().length>=b.valLengthMin?"":a.data("valLength")}},{name:"valRegexPattern",validator:function(a,b){var c=b.valRegexPattern.replace("(?i)[^","^["),d=new RegExp(c,"i");return d.test(a.val())?"":a.data("valRegex")}},{name:"valRemoteUrl",validator:function(a,b){for(var c=b.valRemoteUrl,d=b.valRemoteAdditionalfields.replace(/\*/g,"").split(","),e=null,f={},g=0;g<d.length;g++)e=$('*[name*="'+d[g]+'"]'),f[e.attr("name").replace(".","")]=e.val();var h=null;return yTos.ajax(c+"?"+$.param(f),{async:!1,success:function(a){h=a.IsValid}}),""!==a.val().toString()?"":a.data("valRemote")}},{name:"creditCardChecksum",isMandatory:function(a){return a.data("checksum-mandatory")},validator:function(a,b){var c=a.val();if("string"==typeof c&&(c=$.trim(c)),0===c.length)return!1;c=c.replace(/\s/g,"");for(var d,e=c,f=0,g=1,h=e.length-1;h>=0;h--)d=Number(e.charAt(h))*g,d>9&&(f+=1,d-=10),f+=d,g=1===g?2:1;var i=f%10===0,j=!!a.data("checksum-mandatory"),k=i,l=a.data("creditCardChecksum");return i||j?i&&$Y.notify("yTos::AjaxForm::LuhnCheckSumInfoValidated"):$Y.notify("yTos::AjaxForm::LuhnCheckSumInfo",{message:l}),k?"":l}},{name:"valCustomRule",validator:function(a,b){return"false"===b.valCustomRuleChecksum||b.valCustomRuleChecksum===!1?b.valCustomRuleMessage:""}}],validateOnBlur:function(a){var b=$(a.currentTarget),c=this.getScope(b),d=this.validateInput(b);this.notifyResult(b,d,c)},notifyResult:function(a,b,c){$Y.notify("yTos::AjaxForm::InputValidated",{input:a,isValid:b}),$Y.notify("yTos::AjaxForm::AjaxFormInputValidated",{input:a,isValid:b},{scope:c})},passwordStrength:function(a){var b=$(a.currentTarget),c=b.parents("[data-ytos-password-container]"),d=c.find("*[data-ytos-password-strength]"),e=b.val(),f=6,g=new RegExp("^[\\-a-z0-9\\'\\^&\\*\\(\\)\\/#!_@%\\.\\$\\|\\?=\\\\]{"+f+",15}$","i"),h={strength:-1},i=-1,j={weak:{strength:0,regex:"(?=.{6,}).*"},medium:{strength:1,regex:"^(?=.{6,})((?=.*[a-zA-Z])(?=.*[0-9])|(?=.*[a-zA-Z])(?=.*[\\W_])|(?=.*[0-9])(?=.*[\\W_])).*$"},strong:{strength:2,regex:"^(?=.{6,})((?=.*[a-zA-Z])(?=.*[\\W_])(?=.*[0-9])).*$"}};if(b.val().length<=f&&d.find("*[data-ytos-password-level]").removeClass("selected"),b.val().length>=f){for(var k in j)j.hasOwnProperty(k)&&new RegExp(j[k].regex,"g").test(e)&&j[k].strength>h.strength&&(h=j[k],i=k);d.find("*[data-ytos-password-level]").removeClass("selected"),d.find("[data-ytos-password-level='"+i+"']").addClass("selected"),$Y.notify("yTos::AjaxForm::PasswordStrength",{level:i,strength:h.strength})}return g.test(e)},charCount:function(a){var b=$(a.currentTarget),c=b.data("val-length-max");if("undefined"!=typeof c){var d=$("[data-ytos-char-count-wrapper]"),e=d.find("[data-ytos-char-count-msg]"),f=b.val(),g=c-f.length;g<=0?(d.addClass("charLimitReached"),g=0,b.val(f.substr(0,c))):d.removeClass("charLimitReached"),e.html(g),$Y.notify("yTos::AjaxForm::CharCount",{inputId:b.attr("id"),remainingChars:g})}},validateInput:function(a){var b=a.parents("*[data-ytos-input-container]"),c=a[0].name.split(".")[0],d=a.data(),e=!0,f="undefined"!=typeof d.valRequired||""!==a.val();return b.find("*[data-ytos-validation-msg]").hide(),b.removeClass("invalidRow").addClass("validRow"),a.removeClass("invalid").addClass("valid"),f&&this.validationRules.every(function(f){return e=this._tryValidateInputField(f,d,c,a,b)}.bind(this)),e},_tryValidateInputField:function(a,b,c,d,e){var f=!!b[a.name];if(f){var g=this._isMandatory(d,a),h=a.validator(d,b,c),i=""===h;if(this._attachValidationClasses(d,e,i,g),this._tryAttachErrorMessage(e,a.name,h,i),!i&&("valRequired"===a.name||g))return!1}return!0},_isMandatory:function(a,b){return b&&"function"==typeof b.isMandatory?b.isMandatory(a):!a.is("[data-validation-mandatory]")||a.data("validation-mandatory")},_tryGetErrorContainer:function(a,b){var c=a.find('*[data-ytos-validatedrule="'+b+'"]');return 0===c.length&&(c=$(this.validationTemplate),c.attr("data-ytos-validatedrule",b),c.appendTo(a)),c.eq(0)},_tryAttachErrorMessage:function(a,b,c,d){var e=a.find("*[data-validation-container-for]"),f=this._tryGetErrorContainer(e,b);if(d)f.hide();else{var g=this._tryGetMessageContainer(f);g.html(c),e.html(f),f.show(),g.show()}},_tryGetMessageContainer:function(a){var b;return b=a[0]&&a[0].getAttribute("data-ytos-validation-msg")?a:a.find("*[data-ytos-validation-msg]").length>0?a.find("*[data-ytos-validation-msg]"):a.filter("*[data-ytos-validation-msg]")},_attachValidationClasses:function(a,b,c,d){a.removeClass("valid").removeClass("invalid").removeClass("warning"),b.removeClass("invalidRow").removeClass("validRow").removeClass("warningRow"),!c&&d?(a.addClass("invalid"),b.addClass("invalidRow")):c||d?(a.removeClass("invalid").addClass("valid"),b.removeClass("invalidRow").addClass("validRow")):(a.addClass("warning"),b.addClass("warningRow"))},resetInputValidation:function(a){var b=a.parents("[data-ytos-input-container]"),c=b.find("[data-validation-container-for]");b.removeClass("invalidRow validRow"),a.removeClass("invalid valid"),c.empty()},validateForm:function(a){var b=!0;return $(a).find("[data-val]").each(function(a,c){var d=$(c),e=d.data("val"),f=!0;(e||""!==d.val())&&(f=this.validateInput(d)),b=b&&f}.bind(this)),$Y.notify("yTos::AjaxForm::FormValidated",{form:a,isFormValid:b}),b},resetForm:function(a){var b=$(a),c=this.getScope(b);b.find("[data-ytos-input-container]").find("input, select, textarea").filter(":not([readonly])").each(function(a,b){var c=$(b),d=$(b)[0].type,e=$(b)[0].tagName;"checkbox"!==d&&"radio"!==d||"INPUT"!==e?"SELECT"===e?c.removeAttr("selected"):("hidden"!==d&&"INPUT"===e||"TEXTAREA"===e)&&c.val(""):c.removeAttr("checked")}),$Y.notify("yTos::AjaxForm::FormReset",{form:b}),$Y.notify("yTos::AjaxForm::AjaxFormReset",{form:b},{scope:c})},submitTroughAjax:function(a){var b=a.currentTarget,c=$(b),d=c.serializeArray(),e=c.data("ytos-ctrl")||c.closest("[data-ytos-ctrl]").data("ytos-ctrl"),f=this.getScope(c);if(this.validateForm(b)){$Y.notify("yTos::BeginAjaxRequest",{element:c}),$Y.notify("yTos::BeginAjaxFormRequest",{element:c},{scope:f});var g=$Y.getAbsoluteURL(c.attr("action"),$Y.isCORSSupported());yTos.ajax(g,{type:b.method,data:d,xhrFields:{withCredentials:!0},headers:{"X-Requested-With":"XMLHttpRequest"},success:function(a){var b=$(this).data(),c=b.ytosFormSuccess;if(e&&"function"==typeof e[c])e[c](a);else if("string"==typeof c)if(b.ytosFormScope){var d=e.scope;$Y.notify(c,a,{scope:d})}else $Y.notify(c,a);else $(this).html($.trim(a));$Y.notify("yTos::EndAjaxRequest",{element:$(this)}),$Y.notify("yTos::EndAjaxFormRequest",{element:$(this)},{scope:f})}.bind(b),error:function(a,b,c,d){var e=$(this),g=$($.trim(b.responseText)),h=e.data("ytos-form-error"),i=null;if(g.find("form").length>0){i=g.find("form").children(),e.html(i);var j=e.closest("[data-ytos-ctrl]");j.length>0&&(yTos.helpers.destroyPlugins(j,!0),yTos.helpers.initializeHelpers(j,{isAsyncronouslyLoaded:!0}))}else g.filter("form").length>0?(i=g.children(),e.html(i)):i=g;if(403===b.status&&a&&"function"==typeof a.refreshOnAntiforgeryException&&a.refreshOnAntiforgeryException(),a&&"function"==typeof a[h])a[h](i,b.status,d);else if(h)if($(this).data().ytosFormScope){var k=a.scope;$Y.notify(h,i,{scope:k})}else $Y.notify(h,i);var l=e.find("[data-ytos-validation-summary]");l.length&&$Y.focusElement(l.get(0)),$Y.notify("yTos::EndAjaxRequest",{element:e}),$Y.notify("yTos::EndAjaxFormRequest",{element:e},{scope:f})}.bind(b,e)})}return a.preventDefault(),!1},getScope:function(a){var b=a.yTos("scope")||a.parents("form[data-ytos-scope]").yTos("scope");return b||!!b}});return $Y.notify("yTos::HelperParsed::ui.ajaxForm",a),new a}(),$Y.notify("yTos::HelperLoaded::ui.ajaxForm",yTos.helpers.UI.AjaxForm),yTos.helpers.UI.AjaxForm});