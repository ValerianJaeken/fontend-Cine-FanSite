define(["ytos.search","ui.picturePolyfill"],function(a,b){return yTos.utils.namespace("yTos.helpers.Search.Products"),yTos.helpers.Search.Products=yTos.helpers.base.extend({initialize:function(){this.model=yTos.models.Searches({scope:"mainSearch"}),$Y.safeGet(this.options,"mainImageOptions.LazyLoadFlag")&&require(["vendor.lazyload"],function(a){this.$el.attr("data-ytos-id",this._id);var b={elements_selector:'[data-ytos-id="'+this._id+'"] img',data_srcset:"srcset",data_src:"origin",threshold:300,throttle:500,show_while_loading:!0};$Y.isSrcsetSupported()||(b.callback_set=function(a){this.notify("yTos::Ui:PicturePolyfill::PictureUpdated",{$el:$(a)})}.bind(this));var c=this.getStoreConfiguration();this.lazyloadManager=new a($.extend(!0,b,c))}.bind(this),function(a){yTos.debug.log("Failed loading javascript file: "+a.originalError.currentTarget.src)}),this.model.watch("change:filters",this.wrapFn("getItems")),this.itemSelector="[data-ytos-item]",yTos.search?(this.startingPage=Number(yTos.search.page),this.allProductsLoaded=this.startingPage>=Number(yTos.search.totalPages),this.notify("yTos::Search::NotAllPagesLoaded")):(this.startingPage=1,this.allProductsLoaded=!0,this.notify("yTos::Search::AllProductsReady")),this.options.enableInfiniteScroll&&this.initInfiniteScroll(),this.updateProducts()},globalMessages:{"yTos::Search::AllProductsReady":"scrollToCode10","yTos::Search::NotAllPagesLoaded":"scrollToCode10"},events:{"[data-ytos-item] a [data-ytos-image-box] click":"observeItem","[data-ytos-item] > [data-ytos-image-box] a click":"observeItem"},scrollToCode10:function(){console.log(" ");var a=$Y.storage.cache("scrollTo"),b=this.removeParameter(History.getState());if(a&&null!==a.code10&&this.hashMatch(a.hash,b)){var c=this.$el.find('[data-ytos-item="'+a.code10+'"]');c.length>0?($Y.storage.cache("scrollTo",a,0),this.scrollToElement(c),this.notify("yTos::Search::ScrollToCode10",{code10:a.code10})):this.notify("yTos::Search::Code10NoScroll",{reason:"productNotFound"})}else{var d=a&&null!==a.code10&&this.hashMatch(a.hash,b)?"timeExpired":"hashNoMatch";this.notify("yTos::Search::Code10NoScroll",{reason:d})}},scrollToElement:function(a){var b=a.get(0),c=b.x?b.x:b.offsetLeft,d=b.y?b.y:b.offsetTop;window.scrollTo(c,d)},hashMatch:function(a,b){return JSON.stringify(a)===JSON.stringify(b)},getStoreConfiguration:function(){try{return yTos.configuration.ui.lazyload||{}}catch(a){return{}}},wrapFn:function(a){var b=this;return function(a,b){b[a].apply(b)}.bind(this,a,b)},initInfiniteScroll:function(){this.windowHeight=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,this.lastItemData={},this.$body=$("body"),this.lastPageToLoad=0,this.getLastItemData(),$(window).on("scroll resize",$Y.debounce(this.onScroll.bind(this),250,!1))},observeItem:function(a){if(this.options.enableInfiniteScroll){a.preventDefault();var b=$(a.currentTarget),c=b.find("img").data("ytos-code10"),d=b.parent().attr("href")||b.attr("href"),e=this.removeParameter(History.getState());$Y.storage.cache("scrollTo",{code10:c,hash:e},3),$Y.redirect(d)}},removeParameter:function(a){return null!==a&&"undefined"!=typeof a&&(delete a.data.page,a.hash=a.hash.replace(/"page":"\d*",/g,""),a.url=a.url.replace(/"page":"\d*",/g,""),$Y.storage.get("yTos.navigation.LatestSearchHasTextSearch")===!1&&(delete a.data.textSearch,a.hash=a.hash.replace(/"textSearch":"\d*",/g,""),a.url=a.url.replace(/"textSearch":"\d*",/g,""))),a},getItems:function(a){var b={};a&&"object"==typeof a?b={page:a.page}:isNaN(parseInt(a,10))||(b={page:a});var c=this.options.action||"RenderProducts",d=this.model.getEscapedFiltersForProducts(b);this.getHTML("/Search/"+c+"?"+d+"&siteCode="+yTos.navigation.SiteCode,{success:function(a){this.onProductsLoaded(a),this.notify("yTos::Ui:PicturePolyfill::PictureUpdated",{$el:this.$el})}.bind(this),stripMe:!0})},updateProducts:function(){this.lastPageToLoad=Number(this.model.get("filters").page)||0,this.model.get("mustUpdate")&&(this.options.enableInfiniteScroll?this.model.get("mustResetProducts")?this.currentLoadingPage=this.startingPage:this.currentLoadingPage=this.startingPage+1:this.currentLoadingPage=this.lastPageToLoad,this.getItems(this.currentLoadingPage))},onProductsLoaded:function(a){this.updateProductsHTML(a),this.getLastItemData(),this.lazyloadManager&&"function"==typeof this.lazyloadManager.update&&this.lazyloadManager.update(),this.notify("yTos::Search::ProductsReady",a),this.options.enableInfiniteScroll&&this.model.get("mustUpdate")&&this.currentLoadingPage<this.lastPageToLoad?(this.currentLoadingPage++,this.getItems(this.currentLoadingPage)):0===a.length||Number(yTos.search.page)>=Number(yTos.search.totalPages)||Number(this.model.get("filters").page)>=Number(yTos.search.totalPages)?(this.allProductsLoaded=!0,this.notify("yTos::Search::AllProductsReady")):(this.allProductsLoaded=!1,this.notify("yTos::Search::NotAllPagesLoaded"))},onScroll:function(){this.getLastItemData();var a=this.lastItemData.actionPosition;if(this.getScrollTop()>=a&&!this.allProductsLoaded){this.lastItemData.actionPosition=1/0;var b=this.model.get("filters"),c=parseInt(b.page,10)||1;this.model.setFilter({key:"page",value:c+1})}},updateProductsHTML:function(a){this.model.get("mustResetProducts")?(this.model.set("mustResetProducts",!1),this.$el.html(a)):this.options.enableInfiniteScroll&&!this.model.get("isFiltering")?(a.attr({"data-ytos-page":this.currentLoadingPage}),!this.currentLoadingPage||this.currentLoadingPage>this.startingPage?this.$el.append(a):this.$el.prepend(a)):a.length>=0&&this.$el.html(a)},getScrollTop:function(){var a=this.$body.scrollTop()||document.documentElement.scrollTop;return a+this.scrollBarHeight},getLastItemData:function(){var a=36,b=this.$el.find(this.itemSelector+":last").length>0?this.$el.find(this.itemSelector+":last"):this.$el.find("a:last");if(0===b.length)return!1;var c=0,d=0,e=0,f=$(document).height(),g=200;c=parseInt(b.offset().top,10),d=parseInt(b[0].offsetHeight,10);var h=100*f/this.windowHeight/100;this.scrollBarHeight=this.windowHeight/h+a,this.scrollBarHeight=Math.round(this.scrollBarHeight),e=c-d-a-this.scrollBarHeight;var i=document.documentElement.scrollHeight-document.documentElement.clientHeight+this.scrollBarHeight;e>=i?e=i-(e-i)-d:i-e<=g&&(e=e-g-d),this.lastItemData={domElm:b,offsetTop:c,offsetHeight:d,actionPosition:e}}}),yTos.helpers.Search.Products});