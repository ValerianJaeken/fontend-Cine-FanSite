define(["ytos.search","ui.selectAsList"],function(a,b){return yTos.utils.namespace("yTos.helpers.Search.TextBox"),yTos.helpers.Search.TextBox=yTos.helpers.base.extend({initialize:function(){this.$textSearchInput=this.$el.find('input[name="textsearch"]'),this.$input=this.$el.find('[data-ytos-input][type="text"]'),this.$textSearchInput.val(""),this.options.IsFaytEnabled&&(this.$suggestionContainer=$("<div/>",{id:"suggestionContainer","data-ytos":"suggestionContainer"}).css({display:"none"}),this.$el.append(this.$suggestionContainer),this.$input.bind("change keyup focus",this.updateSuggestions.bind(this))),this.$el.on("submit",function(a){a.isFAYT=this.options.IsFaytEnabled&&this.$textSearchInput.val()!==this.$input.val(),this.submitHandler(a)}.bind(this)),this.updateDefaults()},defaults:{query:"",previousQuery:!1,postBody:{Gallery:"",Gender:"D,U,E",Season:"",TextSearch:"",LanguageId:"",Department:""}},data:{},requiredHelpers:{SelectAsList:b},updateDefaults:function(){var a,b=function(a,b){return $(b).attr("name").toLowerCase()===c.toLowerCase()};for(var c in this.defaults.postBody)this.defaults.postBody.hasOwnProperty(c)&&(a=this.$el.find("input[type='hidden']").filter(b),a.length>0&&(this.defaults.postBody[c]=a.val()))},selectResult:function(){var a=$.trim(this.$selectedSuggestion.find("a").contents(":not(span)").text()),b=$.Event("submit");b.isFAYT=!0,this.$textSearchInput.val(a),this.$el.trigger(b),this.updateInputValue()},updateInputValue:function(){""!==this.$textSearchInput.val()?this.$input.val(this.$textSearchInput.val()):this.$textSearchInput.val(this.$input.val())},submitHandler:function(a){this.updateInputValue(),yTos.tracking.trackEvent({event:a.isFAYT?"TextSearch_FAYT":"TextSearch",label:this.$textSearchInput.val()})},updateSuggestions:function(a){var b=a.currentTarget.value;this.$textSearchInput.val(b),b.length>this.options.QueryMinLength&&b!==this.defaults.previousQuery?(this.defaults.previousQuery=this.defaults.query=b,this.getSuggestions()):b.length>this.options.QueryMinLength&&this.openSuggestionList()},enableListNavigation:function(){this.listNavigationEnabled||($(document).on("keyup",this.navigationHandler.bind(this)),$(document).on("click",this.closeSuggestionList.bind(this)),this.$suggestionContainer.on("mouseover","li",this.updateSelectedSuggestion.bind(this)),this.$suggestionContainer.on("click","li",this.selectResult.bind(this)),this.listNavigationEnabled=!0)},disableListNavigation:function(){this.listNavigationEnabled&&($(document).off("keyup",this.navigationHandler.bind(this)),$(document).off("click",this.closeSuggestionList.bind(this)),this.$suggestionContainer.off("mouseover","li",this.updateSelectedSuggestion.bind(this)),this.$suggestionContainer.off("click","li",this.selectResult.bind(this)),this.listNavigationEnabled=!1)},openSuggestionList:function(a){this.$suggestionContainer.hasClass("open")||(this.$suggestionContainer.slideDown(),this.$suggestionContainer.addClass("open"),this.enableListNavigation(),this.notify("yTos::Search::FaytSuggestionListOpened"))},closeSuggestionList:function(a){this.$input[0]!==$(a.target)[0]&&(this.$suggestionContainer.slideUp(),this.$suggestionContainer.removeClass("open"),this.disableListNavigation())},updateSelectedSuggestion:function(a){this.$selectedSuggestion&&this.$selectedSuggestion.removeClass("selected"),this.$selectedSuggestion=$(a.currentTarget),this.$textSearchInput.val($.trim(this.$selectedSuggestion.find("a").contents(":not(span)").text())),this.$selectedSuggestion.addClass("selected")},navigationHandler:function(a){var b=a.which,c=this.$suggestionContainer.find(".selected");"undefined"!=typeof c[0]&&c[0]===this.$selectedSuggestion[0]||(this.$selectedSuggestion=null),this.$selectedSuggestion&&this.$selectedSuggestion.removeClass("selected"),38!==b&&40!==b||(38===b?this.$selectedSuggestion&&0!==this.$selectedSuggestion.prev().length?this.$selectedSuggestion=this.$selectedSuggestion.prev():this.$selectedSuggestion=this.$suggestionContainer.find("li").last():40===b&&(this.$selectedSuggestion&&0!==this.$selectedSuggestion.next().length?this.$selectedSuggestion=this.$selectedSuggestion.next():this.$selectedSuggestion=this.$suggestionContainer.find("li").first()),this.$textSearchInput.val($.trim(this.$selectedSuggestion.find("a").contents(":not(span)").text())),this.$selectedSuggestion.addClass("selected"))},getSuggestions:function(){if(this.request&&this.request.abort(),this.defaults.postBody.TextSearch=this.defaults.query,this.defaults.postBody.Gender=this.defaults.postBody.Gender||yTos.navigation.Gender,this.options.IsGenderPickerEnabled){var a=this.$el.find('[name="gender"]');a.is("select")&&(this.defaults.postBody.Gender=a.val()),a.is(":radio")&&(this.defaults.postBody.Gender=a.filter(":checked").val())}this.notify("yTos::Search::FaytSearchStarted"),this.request=yTos.ajax("/yTos/SearchPlugin/Lookup/"+this.options.ViewType,{timeout:5e3,contentType:"application/json",data:JSON.stringify({lookupData:this.defaults.postBody}),type:"POST",success:function(a){this.request=!1,this.previousQuery=this.query,this.$suggestionContainer.html(a),this.notify("yTos::Search::FaytSearchEnded",{response:a}),this.openSuggestionList()}.bind(this),error:function(a){this.request=!1,"abort"!==a.statusText&&yTos.log(a)}})}}),yTos.helpers.Search.TextBox});